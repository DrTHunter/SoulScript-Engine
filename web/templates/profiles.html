{% extends "base.html" %}
{% block title %}Profiles ‚Äî SoulScript Engine{% endblock %}

{% block content %}
<style>
  .tab-bar {
    display:flex; align-items:center; gap:0; border-bottom:1px solid #2a2a3a; margin-bottom:1.5rem;
  }
  .tab-btn {
    display:inline-flex; align-items:center; gap:0.5rem;
    padding:0.75rem 1.25rem; font-size:0.875rem; font-weight:600;
    color:#71717a; background:none; border:none; cursor:pointer;
    border-bottom:2px solid transparent; transition:all 0.15s;
    position:relative; top:1px;
  }
  .tab-btn:hover { color:#a1a1aa; }
  .tab-btn.active { color:#fff; border-bottom-color:#6366f1; }

  .agents-grid {
    display:grid; grid-template-columns:repeat(2,1fr); gap:0.75rem; margin-bottom:1.5rem;
  }
  @media (max-width:768px) { .agents-grid { grid-template-columns:1fr; } }

  .agent-card {
    background:#1a1a24; border:1px solid #2a2a3a; border-radius:0.75rem;
    padding:1rem 1.25rem; cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; gap:1rem; position:relative;
  }
  .agent-card:hover { border-color:rgba(99,102,241,0.4); transform:translateY(-2px); }
  .agent-card-avatar {
    width:3rem; height:3rem; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:1.25rem; font-weight:800; color:#fff; flex-shrink:0;
  }
  .agent-card-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
  .agent-card-info { flex:1; min-width:0; }
  .agent-card-name { font-size:0.9375rem; font-weight:700; color:#e4e4e7; text-transform:capitalize; }
  .agent-card-model {
    font-size:0.6875rem; color:#52525b; margin-top:0.25rem;
    font-family:ui-monospace,SFMono-Regular,monospace;
  }
  .agent-card-menu {
    position:absolute; top:0.5rem; right:0.5rem;
    background:none; border:none; color:#52525b; cursor:pointer;
    font-size:1.125rem; padding:0.25rem 0.375rem; border-radius:0.375rem;
    opacity:0; transition:all 0.15s;
  }
  .agent-card:hover .agent-card-menu { opacity:1; }
  .agent-card-menu:hover { color:#e4e4e7; background:rgba(99,102,241,0.15); }
  .agent-add-card {
    border-style:dashed; border-color:#3a3a4a; color:#52525b;
    display:flex; align-items:center; justify-content:center; gap:0.5rem;
  }
  .agent-add-card:hover { border-color:#6366f1; color:#818cf8; }

  /* Editor */
  .editor-view { display:none; animation:viewFade 0.2s ease; }
  .editor-view.active { display:block; }
  @keyframes viewFade { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
  .profile-card {
    background:#1a1a24; border:1px solid #2a2a3a; border-radius:0.75rem;
    padding:1.5rem 2rem; margin-bottom:1.25rem;
  }
  .section-label {
    font-size:0.75rem; font-weight:600; text-transform:uppercase;
    letter-spacing:0.05em; color:#71717a; margin-bottom:0.75rem;
  }
  .prompt-textarea {
    width:100%; background:rgba(15,15,20,0.6); border:1px solid #2a2a3a;
    border-radius:0.5rem; padding:0.75rem 1rem; color:#d4d4d8;
    font-size:0.8125rem; font-family:ui-monospace,SFMono-Regular,monospace;
    line-height:1.6; resize:vertical; min-height:12rem; outline:none;
  }
  .prompt-textarea:focus { border-color:#6366f1; }

  /* Knowledge attach ‚Äî attached list */
  .attached-list { display:flex; flex-direction:column; gap:0.5rem; }
  .attached-item {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.75rem 1rem; border-radius:0.625rem;
    background:rgba(26,26,36,0.5); border:1px solid #2a2a3a;
    transition:all 0.15s;
  }
  .attached-item:hover { border-color:rgba(99,102,241,0.3); }
  .attached-item-info { flex:1; min-width:0; }
  .attached-item-title { font-size:0.875rem; color:#d4d4d8; font-weight:600; }
  .attached-item-remove {
    background:none; border:none; color:#52525b; cursor:pointer;
    font-size:1rem; padding:0.25rem 0.375rem; border-radius:0.25rem;
    transition:all 0.15s;
  }
  .attached-item-remove:hover { color:#ef4444; background:rgba(239,68,68,0.1); }

  /* Mode toggle ‚Äî prominent pill */
  .mode-pill {
    display:inline-flex; align-items:center; gap:0;
    border-radius:9999px; overflow:hidden; border:1px solid #2a2a3a;
    font-size:0.75rem; font-weight:600; cursor:pointer; user-select:none;
  }
  .mode-pill-opt {
    padding:0.3rem 0.75rem; transition:all 0.15s; color:#52525b;
    background:transparent;
  }
  .mode-pill.always .mode-pill-opt.opt-always {
    background:rgba(16,185,129,0.2); color:#34d399;
    box-shadow:inset 0 0 8px rgba(16,185,129,0.15);
  }
  .mode-pill.directive .mode-pill-opt.opt-directive {
    background:rgba(99,102,241,0.2); color:#a5b4fc;
    box-shadow:inset 0 0 8px rgba(99,102,241,0.15);
  }

  /* Knowledge picker popup */
  .picker-list { max-height:24rem; overflow-y:auto; }
  .picker-item {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.625rem 0.75rem; border-radius:0.5rem;
    cursor:pointer; transition:all 0.1s; border:1px solid transparent;
  }
  .picker-item:hover { background:rgba(99,102,241,0.06); }
  .picker-item.selected { border-color:rgba(99,102,241,0.3); background:rgba(99,102,241,0.08); }
  .picker-item-check {
    width:1.25rem; height:1.25rem; border-radius:0.375rem;
    border:2px solid #3a3a4a; display:flex; align-items:center;
    justify-content:center; flex-shrink:0; transition:all 0.15s;
    font-size:0.75rem; color:transparent;
  }
  .picker-item.selected .picker-item-check {
    border-color:#6366f1; background:rgba(99,102,241,0.3); color:#fff;
  }
  .add-knowledge-btn {
    display:inline-flex; align-items:center; gap:0.5rem;
    padding:0.5rem 1rem; border-radius:0.5rem;
    background:rgba(99,102,241,0.12); border:1px solid rgba(99,102,241,0.2);
    color:#818cf8; font-size:0.8125rem; font-weight:600; cursor:pointer;
    transition:all 0.15s;
  }
  .add-knowledge-btn:hover { background:rgba(99,102,241,0.2); border-color:rgba(99,102,241,0.35); }
</style>

<div>
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-white">Agent Profiles</h1>
    <p class="text-sm text-forge-muted mt-1">Manage agent identities, system prompts, and knowledge attachments</p>
  </div>

  <!-- ‚ïê‚ïê‚ïê AGENT LIST VIEW ‚ïê‚ïê‚ïê -->
  <div id="list-view">
    <div class="agents-grid" id="agents-grid">
      {% for name in agents %}
      {% set ad = agent_data[name] %}
      {% set av = avatar_map.get(name, {}) %}
      <div class="agent-card" onclick="openEditor('{{ name }}')">
        <button class="agent-card-menu" onclick="event.stopPropagation();deleteAgent('{{ name }}')" title="Delete">‚úï</button>
        {% if av.get('image') %}
        <div class="agent-card-avatar"><img src="{{ av.image }}" alt="{{ name }}"></div>
        {% else %}
        <div class="agent-card-avatar" style="background:{{ av.get('color', '#6366f1') }};">{{ name[0] | upper }}</div>
        {% endif %}
        <div class="agent-card-info">
          <div class="agent-card-name">{{ ad.display_name or name }}</div>
          <div class="agent-card-model">{{ ad.config.get('model', ad.profile.get('model', 'default')) }}</div>
        </div>
      </div>
      {% endfor %}
      <div class="agent-card agent-add-card" onclick="showCreateModal()">
        <span style="font-size:1.5rem;">+</span>
        <span style="font-size:0.8125rem;font-weight:600;">New Agent</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê EDITOR VIEW ‚ïê‚ïê‚ïê -->
  <div id="editor-view" class="editor-view">
    <div class="flex items-center gap-3 mb-4">
      <button onclick="closeEditor()" class="filter-btn" style="cursor:pointer;">‚Üê Back</button>
      <h2 id="editor-name" class="text-xl font-bold text-white capitalize"></h2>
    </div>

    <!-- System Prompt -->
    <div class="profile-card">
      <div class="section-label">System Prompt</div>
      <p class="text-xs text-forge-muted mb-3">
        <strong>Layer 1</strong> of the prompt injection pipeline.
        This is the agent's base identity ‚Äî always injected first.
      </p>
      <textarea id="ed-system-prompt" class="prompt-textarea"></textarea>
    </div>

    <!-- Model Selection -->
    <div class="profile-card">
      <div class="section-label">Model</div>
      <select id="ed-model" class="search-input w-full" style="max-width:24rem;">
        <option value="">Use connection default</option>
        {% for m in all_models %}
        <option value="{{ m }}">{{ m }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Knowledge Attachments -->
    <div class="profile-card">
      <div class="section-label">Knowledge Attachments</div>
      <p class="text-xs text-forge-muted mb-3">
        Attach knowledge notes to this agent. Choose injection mode:
        <br><span class="text-forge-success font-semibold">Always</span> = verbatim text, every message (Layer 3).
        <span class="text-forge-accent2 font-semibold">Directive</span> = FAISS semantic retrieval per message (Layer 2 ‚Äî Soul Script).
      </p>

      <!-- Attached knowledge (only shows selected items) -->
      <div class="attached-list mb-4" id="ed-attached-list">
        <!-- Populated by JS -->
      </div>

      <button type="button" class="add-knowledge-btn" onclick="openKnowledgePicker()">
        <span>+</span> Add Knowledge
      </button>
    </div>

    <!-- Save -->
    <div class="flex gap-3 mt-4">
      <button onclick="saveProfile()" class="filter-btn active" style="cursor:pointer;">Save Changes</button>
      <span id="save-status" class="text-xs text-forge-success self-center" style="display:none;">Saved ‚úì</span>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê CREATE AGENT MODAL ‚ïê‚ïê‚ïê -->
  <div id="create-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
    <div class="bg-forge-card border border-forge-border rounded-xl p-6 w-full max-w-md shadow-2xl">
      <h2 class="text-lg font-bold text-white mb-4">Create New Agent</h2>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">Agent Name</label>
        <input id="new-agent-name" type="text" class="search-input w-full" placeholder="e.g. oracle, mentor">
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">System Prompt</label>
        <textarea id="new-agent-prompt" class="prompt-textarea" rows="4" placeholder="You are..."></textarea>
      </div>
      <div class="flex gap-3 mt-6">
        <div class="flex-1"></div>
        <button onclick="hideCreateModal()" class="filter-btn" style="cursor:pointer;">Cancel</button>
        <button onclick="createAgent()" class="filter-btn active" style="cursor:pointer;">Create</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê KNOWLEDGE PICKER MODAL ‚ïê‚ïê‚ïê -->
  <div id="knowledge-picker" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
    <div class="bg-forge-card border border-forge-border rounded-xl p-6 w-full max-w-lg shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-white">Attach Knowledge</h2>
        <button onclick="closeKnowledgePicker()" class="text-forge-muted hover:text-white text-xl" style="cursor:pointer;">‚úï</button>
      </div>
      <p class="text-xs text-forge-muted mb-4">Select knowledge notes to attach to this agent. Click to toggle.</p>
      <div class="picker-list" id="picker-list">
        {% for n in notes %}
        <div class="picker-item" data-id="{{ n.id }}" onclick="togglePickerItem(this)">
          <div class="picker-item-check">‚úì</div>
          <div style="flex:1;min-width:0;">
            <div class="text-sm font-semibold text-zinc-200">{{ n.emoji }} {{ n.title }}</div>
            {% if n.section %}<div class="text-xs text-forge-muted">{{ n.section }}</div>{% endif %}
          </div>
        </div>
        {% endfor %}
        {% if not notes %}
        <p class="text-sm text-zinc-500 p-4 text-center">No knowledge notes yet. Create some in the Knowledge tab.</p>
        {% endif %}
      </div>
      <div class="flex gap-3 mt-5">
        <div class="flex-1"></div>
        <button onclick="closeKnowledgePicker()" class="filter-btn" style="cursor:pointer;">Cancel</button>
        <button onclick="applyKnowledgePicker()" class="filter-btn active" style="cursor:pointer;">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
const _agentData = {{ agent_data | tojson }};
const _allNotes = {{ notes | tojson }};
let _editingAgent = null;
let _attachedIds = [];  // currently attached note IDs
let _noteModes = {};    // noteId ‚Üí 'always' | 'directive'

/* ‚ïê‚ïê‚ïê Build note map for quick lookup ‚ïê‚ïê‚ïê */
const _noteMap = {};
_allNotes.forEach(n => _noteMap[n.id] = n);

function openEditor(name) {
  _editingAgent = name;
  const ad = _agentData[name] || {};
  const cfg = ad.config || {};

  document.getElementById('editor-name').textContent = cfg.display_name || name;
  document.getElementById('ed-system-prompt').value = ad.system_prompt || '';
  document.getElementById('ed-model').value = cfg.model || ad.profile?.model || '';

  // Load attachments
  _attachedIds = [...(cfg.attached_notes || [])];
  _noteModes = {...(cfg.note_modes || {})};
  // Default missing modes to 'always'
  _attachedIds.forEach(id => { if (!_noteModes[id]) _noteModes[id] = 'always'; });

  renderAttachedList();

  document.getElementById('list-view').style.display = 'none';
  document.getElementById('editor-view').classList.add('active');
}

function closeEditor() {
  _editingAgent = null;
  document.getElementById('editor-view').classList.remove('active');
  document.getElementById('list-view').style.display = '';
}

/* ‚ïê‚ïê‚ïê Render attached knowledge list ‚ïê‚ïê‚ïê */
function renderAttachedList() {
  const container = document.getElementById('ed-attached-list');
  if (_attachedIds.length === 0) {
    container.innerHTML = '<p class="text-sm text-zinc-500 py-3">No knowledge attached yet. Click "Add Knowledge" to attach notes.</p>';
    return;
  }
  container.innerHTML = _attachedIds.map(id => {
    const n = _noteMap[id];
    if (!n) return '';
    const mode = _noteModes[id] || 'always';
    return `
      <div class="attached-item" data-id="${id}">
        <div class="attached-item-info">
          <div class="attached-item-title">${n.emoji || 'üìÑ'} ${n.title}</div>
          ${n.section ? `<div class="text-xs text-forge-muted mt-0.5">${n.section}</div>` : ''}
        </div>
        <div class="mode-pill ${mode}" onclick="cyclePillMode(this, '${id}')" title="Click to switch injection mode">
          <span class="mode-pill-opt opt-always">Always</span>
          <span class="mode-pill-opt opt-directive">Directive</span>
        </div>
        <button class="attached-item-remove" onclick="removeAttached('${id}')" title="Remove">‚úï</button>
      </div>`;
  }).join('');
}

function cyclePillMode(pill, noteId) {
  const current = _noteModes[noteId] || 'always';
  const next = current === 'always' ? 'directive' : 'always';
  _noteModes[noteId] = next;
  pill.className = 'mode-pill ' + next;
}

function removeAttached(id) {
  _attachedIds = _attachedIds.filter(x => x !== id);
  delete _noteModes[id];
  renderAttachedList();
}

/* ‚ïê‚ïê‚ïê Knowledge Picker Modal ‚ïê‚ïê‚ïê */
function openKnowledgePicker() {
  // Mark currently attached items as selected in the picker
  document.querySelectorAll('#picker-list .picker-item').forEach(item => {
    const id = item.dataset.id;
    item.classList.toggle('selected', _attachedIds.includes(id));
  });
  document.getElementById('knowledge-picker').classList.remove('hidden');
}

function closeKnowledgePicker() {
  document.getElementById('knowledge-picker').classList.add('hidden');
}

function togglePickerItem(el) {
  el.classList.toggle('selected');
}

function applyKnowledgePicker() {
  const newIds = [...document.querySelectorAll('#picker-list .picker-item.selected')].map(el => el.dataset.id);
  // Add newly selected ones, keep existing modes
  newIds.forEach(id => {
    if (!_attachedIds.includes(id)) {
      _attachedIds.push(id);
      _noteModes[id] = 'always';
    }
  });
  // Remove unselected ones
  _attachedIds = _attachedIds.filter(id => newIds.includes(id));
  Object.keys(_noteModes).forEach(id => {
    if (!_attachedIds.includes(id)) delete _noteModes[id];
  });
  renderAttachedList();
  closeKnowledgePicker();
}

/* ‚ïê‚ïê‚ïê Save / Delete / Create ‚ïê‚ïê‚ïê */
async function saveProfile() {
  if (!_editingAgent) return;

  // Save profile
  await fetch(`/api/profiles/${_editingAgent}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      system_prompt: document.getElementById('ed-system-prompt').value,
      config: { model: document.getElementById('ed-model').value || undefined },
    }),
  });

  // Save knowledge attachments
  await fetch(`/api/profiles/${_editingAgent}/knowledge`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ attached_notes: _attachedIds, note_modes: _noteModes }),
  });

  const status = document.getElementById('save-status');
  status.style.display = '';
  setTimeout(() => status.style.display = 'none', 2000);
}

async function deleteAgent(name) {
  if (!confirm(`Delete agent "${name}"? This removes the profile and system prompt.`)) return;
  await fetch(`/api/profiles/${name}`, {method:'DELETE'});
  location.reload();
}

function showCreateModal() { document.getElementById('create-modal').classList.remove('hidden'); }
function hideCreateModal() { document.getElementById('create-modal').classList.add('hidden'); }

async function createAgent() {
  const name = document.getElementById('new-agent-name').value.trim();
  const prompt = document.getElementById('new-agent-prompt').value.trim();
  if (!name) return alert('Name required');
  const resp = await fetch('/api/profiles', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name, system_prompt:prompt}),
  });
  const data = await resp.json();
  if (data.error) return alert(data.error);
  location.reload();
}
</script>
{% endblock %}
