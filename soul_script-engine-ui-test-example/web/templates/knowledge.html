{% extends "base.html" %}
{% block title %}Knowledge â€” SoulScript Engine{% endblock %}

{% block content %}
<style>
  .notes-grid {
    display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));
    gap:0.75rem;
  }
  .note-card {
    background:#1a1a24; border:1px solid #2a2a3a; border-radius:0.75rem;
    padding:1rem; cursor:pointer; transition:all 0.15s; position:relative;
  }
  .note-card:hover { border-color:rgba(99,102,241,0.4); transform:translateY(-2px); }
  .note-emoji { font-size:1.5rem; margin-bottom:0.375rem; }
  .note-title { font-size:0.9375rem; font-weight:700; color:#e4e4e7; margin-bottom:0.25rem; }
  .note-preview {
    font-size:0.75rem; color:#71717a; line-height:1.5;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .note-meta { font-size:0.625rem; color:#52525b; margin-top:0.5rem; }
  .note-del {
    position:absolute; top:0.5rem; right:0.5rem;
    background:none; border:none; color:#52525b; font-size:0.875rem;
    cursor:pointer; opacity:0; transition:opacity 0.15s;
  }
  .note-card:hover .note-del { opacity:1; }
  .note-del:hover { color:#ef4444; }
  .add-card {
    border-style:dashed; border-color:#3a3a4a; color:#52525b;
    display:flex; flex-direction:column; align-items:center;
    justify-content:center; gap:0.5rem; min-height:120px;
  }
  .add-card:hover { border-color:#6366f1; color:#818cf8; }
</style>

<div>
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-white">Knowledge</h1>
    <p class="text-sm text-forge-muted mt-1">Create and manage knowledge notes for agent identity injection</p>
  </div>

  <!-- Info Card -->
  <div class="card mb-6">
    <div class="text-xs text-forge-muted leading-relaxed">
      <strong class="text-zinc-300">How knowledge injection works:</strong>
      Attach notes to agents in the Profiles tab. Choose <span class="text-forge-success">Always</span> mode
      for verbatim injection every message, or <span class="text-forge-accent2">Directive</span> mode for
      FAISS semantic retrieval (Soul Script). Directive notes are chunked and indexed â€” only relevant
      sections are injected per conversation turn.
    </div>
  </div>

  <div class="notes-grid">
    {% for n in notes %}
    <div class="note-card" onclick="location.href='/knowledge/{{ n.id }}/edit'">
      <button class="note-del" onclick="event.stopPropagation();deleteNote('{{ n.id }}')" title="Delete">âœ•</button>
      <div class="note-emoji">{{ n.emoji }}</div>
      <div class="note-title">{{ n.title }}</div>
      <div class="note-preview">{{ n.preview or '' }}</div>
      <div class="note-meta">{{ n.section or 'Uncategorized' }}</div>
    </div>
    {% endfor %}
    <div class="note-card add-card" onclick="createNote()">
      <span style="font-size:1.5rem;">+</span>
      <span style="font-size:0.8125rem;font-weight:600;">New Knowledge</span>
    </div>
  </div>
</div>

<script>
async function createNote() {
  const resp = await fetch('/api/knowledge', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({title:'Untitled', emoji:'ðŸ“„'}),
  });
  const note = await resp.json();
  location.href = '/knowledge/' + note.id + '/edit';
}

async function deleteNote(id) {
  if (!confirm('Move this knowledge note to trash?')) return;
  await fetch('/api/knowledge/' + id, {method:'DELETE'});
  location.reload();
}
</script>
{% endblock %}
